<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/cors.js | redux-idle-monitor API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/cchamberlain/redux-webpack-boilerplate" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCors">getCors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-proxy">proxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getServerMap">getServerMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-configureServer">configureServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-devStream">devStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-voidStream">voidStream</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">route</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-configureApi">configureApi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-configureRouter">configureRouter</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/cors.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { createServerLogger, server as serverConfig, origins } from &apos;../config.server&apos;
import { devStream } from &apos;./stream&apos;

const logger = createServerLogger(&apos;cors&apos;)

const logOriginPass = (origin, pattern) =&gt; logger.trace(`PASS: origin [${origin}] matches pattern [${pattern}].`)
const logOriginFail = (origin) =&gt; logger.trace(`FAIL: origin [${origin}] does not match any patterns.`)
const logOriginDNE = () =&gt; logger.trace(&apos;DNE: origin header does not exist.&apos;)

const corsValidator = patterns =&gt; {
  return req =&gt; (typeof req.headers.origin === &apos;string&apos;
                ? patterns.filter(x =&gt; x.test(req.headers.origin))
                          .map(devStream(x =&gt; logOriginPass(req.headers.origin, x))).length &gt; 0
                : true
                )
}

export function getCors() {
  const isOriginOk = corsValidator(origins.map(x =&gt; new RegExp(x)))

  const failureStatus = { code: 403
                        , message: &apos;403 Forbidden&apos;
                        }

  const getError = req =&gt; req.headers.origin  ? ({ message: logOriginFail(req.headers.origin), code: 10 })
                                              : ({ message: logOriginDNE(), code: 11 })

  const getOptionsHeaders = req =&gt; ({ &apos;Access-Control-Allow-Origin&apos;: req.headers.origin
                                    , &apos;Access-Control-Max-Age&apos;: 604800 // Specifies how long the preflight response can be cached in seconds
                                    , &apos;Access-Control-Allow-Methods&apos;: &apos;GET, PUT, POST, DELETE&apos;
                                    , &apos;Access-Control-Allow-Headers&apos;: &apos;Content-Type, Authorization&apos;
                                    , &apos;Access-Control-Allow-Credentials&apos;: true
                                    })

  const handle = (req, res) =&gt; {
    const resolvedOrigin = req.headers.origin || req.headers.host
    if(!isOriginOk(req))
      return req.headers.origin ? logger.error(`proxy -origin [${resolvedOrigin}], method [${req.method}]`) : logger.warn(&apos;proxy -host [%s], method [%s]&apos;, req.headers.host, req.method)
    logger.trace(`proxy +${req.headers.origin ? &apos;origin&apos; : &apos;host&apos;} [${resolvedOrigin}], method [${req.method}]`)
    res.setHeader(&apos;Access-Control-Allow-Origin&apos;, resolvedOrigin)
    res.setHeader(&apos;Access-Control-Allow-Credentials&apos;, true)
  }

  const handlePreflight = (req, res) =&gt; {
    res.writeHead(200, getOptionsHeaders(req))
    res.end()
  }

  const handleFailure = (req, res) =&gt; {
    res.writeHead(failureStatus.code)
    res.end (JSON.stringify({ message: failureStatus.message
                            , errors: [ getError(req) ]
                            }))
  }

  return  { isOriginOk : isOriginOk
          , failureStatus: failureStatus
          , getError: getError
          , getOptionsHeaders: getOptionsHeaders
          , handle: handle
          , handlePreflight: handlePreflight
          , handleFailure: handleFailure
          }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
